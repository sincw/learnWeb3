# 以太坊和智能合约

**计划列表**

| Name              | 学习内容                                                                                                                                                                                               | 学习时长  | 备注  |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----- | --- |
| 1.以太坊             | https://github.com/inoutcode/ethereum_book <br/>精通以太坊<br/>  https://ethereum.org/en/developers/docs/ <br/>区块链、智能合约相关的基础概念，ERC20<br/>Geth的安装和使用<br/>[https://github.com/ethereum/wiki]()<br/>以太坊白皮书 | 16h   |     |
| 2.智能合约            | https://bitcoin.org/en/bitcoin-paper                                                                                                                                                               | 4h    |     |
| 3.solidity+web3js | [GitHub - bitcoin/bitcoin: Bitcoin Core integration/staging tree](https://github.com/bitcoin/bitcoin)                                                                                              | 8h+2h |     |
| 4.实战部分            | https://gitee.com/sincw/web3/tree/master/code/solidity                                                                                                                                             |       |     |

---

### 一、概述

##### 区块链发展史

区块链1.0（比特币） 2008

区块链2.0（智能合约）2014

区块链3.0（高性能，大吞吐，社区庞大）2017-？

##### 为什么学习以太坊

- 庞大的开发者社区，目前最大的区块链开发平台

- 相对成熟、资料多

- 从应用入手，JavaScript语法，方便上手

##### 以太坊是什么

一个世界计算机（一个全球分布的计算基础设施），执行智能合约的程序。ether用于计量和约束执行资源成本。以太坊在主网络运行，在TCP30030上寻址，并运行一个名为DEVP2P的协议。

##### 以太坊和比特币的区别

### 二、以太坊概念

##### 账户

包含地址、余额，随机数、以及可选的存储和代码的对象。

（随机数nonce,用于确定每笔交易只能被处理一次的计数器）

普通账户   存储和代码均为空

合约账户   包含存储和代码

##### 地址

代表一个账户或者合约，他可以链上接收货发送交易。使用ECDSA公钥的keccak散列的最右边160位。

##### 交易

- 可以发送以太币和信息

- 向合约发送的交易可以调用合约代码

- 像空用户发送信息，可以自动生成信息为代码块的合约用户

![](image\0a375304b51f4442a588249387660ffa.png)

##### 挖矿产出

- 区块奖励

            每产生一个新区块就会有固定奖励，一开始是5个，现在是3个。（gas收入，区块内包含的所有程序的gas花费的总和）

- 叔块奖励

            有些区块被挖得晚一些，没有并入主链，称为叔块，如果叔块在后续的区块链中被引用，那叔块就会获得挖矿者产出区块奖励的7/8

（数块高度+8-引用叔块高度）* 普通区块奖励/8 。

- 叔矿引用奖励

            矿工每应用一个叔块，可以获得区块奖励的1/32  

##### GAS

gas是用于测量在以太坊区块链上执行特定操作所需的计算工作量的单位。在以太坊区块链上的每一个操作，或者准确地说在以太坊虚拟机（EVM）上的每一个操作都有一个相对应的gas成本。例如：将两个数字相加要花费3个gas；获取账户余额会花费400个gas；发送一笔交易花费21000个gas。

智能合约通常包括多个操作，这些操作加起来甚至可以花费数十万gas。

##### 以太坊区块结构

![](image\6dc6f6b7cc29c9c0043fb979ce000fb2.png)

##### 查看以太坊信息

https://etherscan.io

##### 以太坊出块时间为什么是12s

由比特币网络的经验，比特币网络在12s左右，就能够广播至全网95%的节点。因此设计出块时间在12s左右

##### GHOST协议

由于出块太快，导致分叉频繁，挖矿更多的收到网络影响。

解决方式就是：计算工作量证明时，不仅仅包括当前区块的父，祖等，还要考虑祖区块作废的后代区块（“叔块”），进行综合考虑。不选择最长链作为主链，而选择最重的链作为主链。就算某个矿场1s出矿，他能连续算出100个块，但是他不是最重的，他所挖出得矿也是会被废弃。

从创世区块(Genesis)开始，每次分叉就选取最重子树，而非最长的，直到确定完主链的序。还是拿图中的例子，最终选取的主链是 **0, 1B, 2C, 3D, 4B**。

![](D:\Learn\web3\note\2\image\50ff040b89c11d24b2587831d0b798fc.png)

![](image\532e9444b10bca421540c2c09231f086.png)

##### 智能合约是什么

##### 以太坊钱包

MetaMask Chrome浏览器扩展应用商店下载

##### 私钥、公钥和地址

私钥（Private Key）
以太坊私钥事实上只是一个256位的随机数，用于发送以太的交易中创建签名来证明自己对资金的所有权。
公钥（Public Key）
公钥是由私钥通过椭圆曲线加密secp256k1算法单向生成的512位 （64字节）数。
地址（Address）
地址是由公钥的 Keccak-256 单向哈希，取最后20个字节（160位）派生出来的标识符。

助记词-》私钥-》公钥-》地址

##### 以太坊网络

Main nerwork 主网(NetWorkID 1)

Ropsten Test Network(NetWorkID 3) Kovan Test NetWork(NeWorkID 42) Rinkeby Test NetWork(NetworkId 4)   公共测试网络

LocalHost 8545    本地节点，改节点可以是任何网络中的节点

##### 以太坊客户端安装

[GitHub - ethereum/go-ethereum: Official Go implementation of the Ethereum protocol](https://github.com/ethereum/go-ethereum)

##### 以太坊交易

签名的数据包，由EOA发送到另一个账户的

- 消息的接收方地址

- 发送方签名

- 金额

- 数据

- start gas

- gas price

##### 消息（类似函数调用A合约调用B合约的可调用方法）

合约可以像其他合约发送消息

消息是不会被序列化的虚拟对象、只存在于执行环境evm中

可以看做函数调用，消息没有签名，所以要加上发送方地址

- 消息发送方

- 消息接收方

- 金额

- 数据

- start gas

##### 合约

- 合约地址  nonce + 交易的hash算出来的

- 可以读写自己的内部存储（32字节的key-value数据库）

- 可向其他合约发送消息、一次触发执行

- 一旦合约运行结束、并且由它发送的消息所有的子执行结束，EVM就会结束执行。

##### 合约应用一

- 维护一个数据存储（账本）、存放对其他合约或外部世界有用的内容

- 最典型的例子是模拟货币的合约（代币）

##### 合约应用二

- 通过合约实现一种具有更复杂的访问策略的普通账户（EOA）、这杯称为转发合同，只有满足某些条件时才执行某些操作。比如等待三份合约中的两份确认之后，在重新发送特定的消息。

- 钱包合约

##### 合约应用三

- 管理多个用户之间的持续合同或关系

- 金融和托或者托管合同

##### 交易的本质

- 交易是eoa发起的签名信息，由以太坊的网络传输、被序列化后记录在以太坊的链上、

- 交易是唯一可以触发状态更改或导致合约在evm中执行的事物。

- 以太坊是一个全局单例状态机、交易是唯一可以改变其状态的东西。

- 合约不是自己运行的、以太坊也不会在后台运行、以太坊的一切变化都始于交易、

##### 交易数据结构

- nonce 普通用户发出的序列号、用于防止交易信息重播。他不是区块链的一部分、他是通过计算发送地址的已确认交易数据来动态计算。nonce可以保证顺序处理，解决双重支付的问题。只有nonce为9号的被打包，nonce为10号的才会被矿工打包。
  
  并发问题：如果两个钱包同时打包了nonce为9的交易。
  
  虽然nonce解决了双花问题，就引入了并发问题。

- gas price 交易发起人愿意支付的gas

- start gas 发起人愿意支付的最大gas

- to 目的地址

- value 发送的数量

- data 可变长度二进制数据负载

- v、r、s    椭圆曲线三个部分

##### 交易中的GAS

- 当交易或者evm运行时，指令会在所有节点上执行。这具有成本、对于每个操作都存在固定的成本、把这个成本用一定量的fas表示。

- gas是交易发起人需要为EVM上的每项操作支付的成本名称、发起交易时、我们需要从执行代码的矿工那里用以太购买gas

- gas由矿工决定、可以拒绝处理gas价格低于最低限额的交易

- 为什么不设计使用手续费？如果程序脚本陷入死循环，那对于矿工来说损失就太大了。其实这也是一种解耦的操作，好处很多。

##### gas计算

- gas limit   类似于押金

- gasUsed  gaslimit中剩余的部分会返回给发送人

- totalCost = gasPrice x gasUsed

- geth计算gas     eth.estimateGas({"交易对象"});

##### 交易的接受者

- 交易接收者在to字段中指定，是一个20字节的以太坊地址。地址可以是EOA或者合约地址。

- 以太坊没有进一步的验证，任何20字节的值都被认为是有效的。如果20字节对应于没有相应私钥的地址，或不存在的合约、则该交易任然有效。以太坊无法知道地址是否从公钥正确派生的。

- 如果交易发送到无效地址，将销毁发送的以太，使其永远无法访问。

- 验证接收人地址是否有效的工作，应该在用户界面一层完成。

##### 交易的value和data

- 交易的主要“有效负载”包含在两个字段、value和data。

- 仅仅有value就是普通交易，仅有data就是合约调用。

- 没有value和data的交易，就是在浪费算力。

##### 向EOA或合约传递DATA

- 当交易包含data时，他很有可能是发送到合约地址的，但它同样可以发送给EOA

- 如果发送data给EOA，解释取决于钱包。类似转账留了一句话。

- 如果发送data给合约地址，那EVM就会解释为函数调用，从data里解析出入参。

- 发送给合约的data是32字节的16进制序列化编码。
  
  --函数选择器：函数原型的keccak256hash的前4个字节。允许evm明确的识别要调用的函数。
  
  --函数参数：根据evm定义的各种基本类型的规则进行编码。

##### 特殊交易：部署合约

- 有一种特殊交易，有data但是没有value，那就是一个创建新合约的交易。

- 合约创建交易被发送到特殊目的地地址，即0x0.该地址不带便eoa也不代表合约。它永远不会花费以太或发起交易，它仅用作目的地，具有特殊含义“创建合约”；

- 合约注册交易不应包含以太值，只包含合约的已编译字节码的数据data。这个交易的唯一效果是注册合约。

##### 以太坊虚拟机EVM

- 以太坊虚拟机就是evm的运行环境

- 作为区块验证协议的一部分，参与网络的每个节点都会运行evm.

- evm不仅沙盒封装，而且是完全隔离的。智能合约之间的访问也受限。

- 合约以字节码的格式存在于区块链上

- 合约通常以solidity编写，通过evm编译器译为字节码，最终通过客户端上传部署到区块链网络。

##### EVM和账户

- 以太坊的两类账户，共用同一个地址空间。
- 无论账户是否存储代码，这两类账户对evm来说处理方式是完全一样的
- 每个账户在evm中都有一个键值对形式的持久化存储。其中key和value的长度都是256位，称之为存储空间。

##### EVM和交易

- 交易可以看做一个账户发送到另一个账户的消息，可以包含二进制数据和以太币

- 如果目标账户含有代码，此代码会在EVM中执行、并以data作为入参，这就是合约的调用

- 如果目标账户是0账户，此交易就将创建一个新合约，这个用来创建合约的交易会被转换为字节码存储

##### EVM和gas

- 合约被交易调用时，会有算力成本，gas用来量化这个成本消耗。

- gas的目的限制执行交易所苏姚的工作量和为交易支付手续费

- EVM执行交易时、gas将按照特定规则逐渐耗尽。

- gas消耗不完会原路返回

- 无论执行到什么位置，一旦gas被耗尽，将会触发out of gas 异常，当前调用帧的所有操作会被回滚。

##### Evm数据存储

Storage 每个账户都有一块持久化的存储空间，称为Storage,将256字映射到256位字的kv存储区，理解为合约的数据库。

Memory 每一次消息调用，合约会临时获取一块干净的内存空间

生命周期为整个方法执行期间，函数调用后回收，英文仅保存临时变量。

Stack EVM不是基于寄存器的，而是基于栈的，因此所有的计算都在栈中执行。

存放部分局部值类型变量，几乎免费试用的内存，但数量有限制。

##### EVM指令集

- 所有的指令都是针对  256位的字（word） 这个基本的数据类型来操作

- 具备常用的算术、位、逻辑和比较操作

- 合约可以访问当前区块的相关属性，比如它的块高度和时间搓

##### 消息调用（Message calls）

- 合约可以通过消息调用的方式来调用其他合约或者发送以太到非合约账户

- 合约可以决定再其内部的消息调用中，对于剩余的gas,应该发送和保留多少

- 如果在内部调用发生了oog异常，此时只有与该内部消息调用一起发送的gas会被消耗掉。

##### 委托调用Delegatecall

- 一种特殊的消息调用

- 目标地址的代码将在发起调用的合约上下文中执行，并且msg.sender和msg.vlue布标

- 可以由此实现‘库’：可复用的代码库可以放在一个合约的存储上，通过委托调用引入相应代码。

##### 合约的创建和自毁

- 通过一个特殊的消息调用create calls ，合约可以创建其他合约

- 通过selfdestruct可以移除合约；剩余的以太会发送给指定的目标。然后存储和代码会被移除。

### 三、以太坊白皮书

https://ethereum.org/zh/developers/docs/

https://github.com/ethereum/wiki/wiki/[中文]-以太坊白皮书

##### 区块链历史

- 1998戴伟引入解决计算难题和去中心化共识创造货币的思想。但并未给出实现。

- 所有电子货币遇到的难题，拜占庭容错。在匿名参与的情况下，安全边界容易受到攻击。

- 中本聪引入  将去中心化共识协议与工作量证明机制结合在一起。通过工作证明获得参与系统的权利。

- 拥有大量算力的节点有更大的影响力，但是整合整合网络51%的算力，比创建一百万个节点困难得多。

##### 比特币解读

比特币账本是一个状态转换系统，发生交易时，状态开始进行转换。

在比特币系统中，状态转换函数`APPLY(S,TX)->S’`大体上可以如下定义：

1. 交易的每个输入：
   - 如果引用的UTXO不存在于现在的状态中（`S`），返回错误提示
   - 如果签名与UTXO所有者的签名不一致，返回错误提示
2. 如果所有的UTXO输入面值总额小于所有的UTXO输出面值总额，返回错误提示
3. 返回新状态`S’`,新状态`S’`中移除了所有的输入UTXO，增加了所有的输出UTXO

第一步的第一部分防止交易的发送者花费不存在的比特币，第二部分防止交易的发送者花费其他人的比特币。第二步确保价值守恒。

默尔克树是块的唯一标识，对于默克尔树的任何部分进行改变的尝试都会最终导致链上某处的不一致。默克尔树对于比特币的长期持续是至关重要的，简化支付确认（SPV)协议允许另一种节点存在，这样的节点被成为“轻节点”，它下载区块头，使用区块头确认工作量证明，然后只下载与其交易相关的默克尔树“分支”。这使得轻节点只要下载整个区块链的一小部分就可以安全地确定任何一笔比特币交易的状态和账户的当前余额。

##### 其他的区块链应用

- 域名币
  
  身份标识是象`1LW79wp5ZBqaHW1jL5TciBCrhQYtHagUWy`这样的伪随机哈希，可以创建sincw的账户，第一个注册者利用pow写入链上后，其他人无法使用。

- 彩色币
  
  对比特币utxo的metaData进行染色，标注red，总共1000w个，整个标注了red的utxo就形成了red币。red币发行了1000w个代表公司的股份，获得10w个red，就代表你拥有1%的股份，将实物与虚拟货币连接了起来。

- 元币
  
  在比特币网络上增加了新的状态转换规则函数`APPLY(S,TX)->S`，他可以回退状态，以太坊也借鉴了这一点（消耗了gas,但还是回退了状态）

##### 脚本

比特币的脚本在一定程度也能实现智能合约，但是有一些严重的限制。

- 缺少图灵完备性

- 价值盲（Value-blindness） UTXO无法分割，唯一的方法就是低效的筛选出合适的UTXO进行发送。

- 缺少状态  UTXO只有两种状态，已花费，未花费。这样就无法实现多阶段期权合约，也无法实现取款限额。

- 区块链盲  UTXO看不到区块链的数据。

##### 以太坊

以太坊的目的是基于脚本、彩色币、链上元协议进行整合和提高，获得功能更加强大的区块链。

状态转换函数 `APPLY(S,TX)->S’`定义如下

1. 检查交易的格式是否正确（即有正确数值）、签名是否有效和随机数是否与发送者账户的随机数匹配。如否，返回错误。
2. 计算交易费用:`fee=STARTGAS * GASPRICE`，并从签名中确定发送者的地址。从发送者的账户中减去交易费用和增加发送者的随机数。如果账户余额不足，返回错误。
3. 设定初值`GAS = STARTGAS`，并根据交易中的字节数减去一定量的瓦斯值。
4. 从发送者的账户转移价值到接收者账户。如果接收账户还不存在，创建此账户。如果接收账户是一个合约，运行合约的代码，直到代码运行结束或者瓦斯用完。
5. 如果因为发送者账户没有足够的钱或者代码执行耗尽瓦斯导致价值转移失败，恢复原来的状态，但是还需要支付交易费用，交易费用加至矿工账户。
6. 否则，将所有剩余的瓦斯归还给发送者，消耗掉的瓦斯作为交易费用发送给矿工。

##### 代码执行

代码由一系列字节构成，每一个字节代表一种操作。一般而言，代码执行是无限循环，程序计数器每增加一（初始值为零）就执行一次操作，直到代码执行完毕或者遇到错误，`STOP`或者`RETURN`指令。操作可以访问三种存储数据的空间：

- **堆栈**，一种后进先出的数据存储，32字节的数值可以入栈，出栈。
- **内存**，可无限扩展的字节队列。
- **合约的长期存储**，一个秘钥/数值的存储，其中秘钥和数值都是32字节大小，与计算结束即重置的堆栈和内存不同，存储内容将长期保持。

##### 区块链和挖矿

区块确认算法

1. 检查区块引用的上一个区块是否存在和有效。
2. 检查区块的时间戳是否比引用的上一个区块大，而且小于15分钟。
3. 检查区块序号、难度值、 交易根，叔根和瓦斯限额（许多以太坊特有的底层概念）是否有效。
4. 检查区块的工作量证明是否有效。
5. 将`S[0]`赋值为上一个区块的`STATE_ROOT`。
6. 将`TX`赋值为区块的交易列表，一共有`n`笔交易。对于属于`0……n-1`的`i`，进行状态转换`S[i+1] = APPLY(S[i],TX[i])`。如果任何一个转换发生错误，或者程序执行到此处所花费的瓦斯（gas）超过了`GASLIMIT`，返回错误。
7. 用`S[n]`给`S_FINAL`赋值, 向矿工支付区块奖励。
8. 检查`S_FINAL`是否与`STATE_ROOT`相同。如果相同，区块是有效的。否则，区块是无效的。

看起来效率很低，因为它需要存储每个区块的所有状态，但事实上它的速度并不慢，原因是状态存储在树结构中（tree structure），每增加一个区块只需要改变树结构的一小部分。因此，一般而言，两个相邻的区块的树结构的大部分应该是相同的，因此存储一次数据，可以利用指针（即子树哈希）引用两次。一种被称为“帕特里夏树”（“Patricia Tree”）的树结构可以实现这一点，其中包括了对默克尔树概念的修改，不仅允许改变节点，而且还可以插入和删除节点。

##### 应用

主要有三种应用，金融（自货币，遗嘱，对冲合约）。半金融（解决问题的悬赏）。在线投票和去中心化治理。

##### 以太坊黄皮书

https://github.com/yuange1024/ethereum_yellowpaper/blob/master/ethereum_yellow_paper_cn.pdf

黄皮书更多描述的是以太坊状态机的运行方式
