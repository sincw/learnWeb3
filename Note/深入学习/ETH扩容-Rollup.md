# ETH-L2扩容方案Rollup

### 什么是RollUp

Rollup 是类似于 Plasma 的第 2 层扩展解决方案：单个主链合约持有所有资金和对更大“侧链”状态（通常是`账户、余额及其状态`的 Merkle 树）的简洁加密承诺。侧链状态由链下用户和运营商维护，不依赖 L1 存储（这是最大的可扩展性胜利的来源）。

Rollup 与 Plasma 的不同之处在于，它解决了 Plasma 的巨大问题——数据可用性——通过 L1 网络发布每笔交易的一些数据（在以太坊中，专门为此目的使用了 tx CALLDATA）。因此，可以将数千个交易捆绑（汇总）在一个汇总块中。虽然这种方法在成本（事务数量的 O(n)）方面严格线性增长，但它提供了实际 100 倍的吞吐量提高，因为 CALLDATA 比 L1 存储和计算便宜得多。

根据如何保证状态转换的正确性，有两种 Rollup 风格：ZK Rollup 和 Optimistic Rollup, 根据不同的项目，又有不同的改进版 Rollup

### RollUp 如何工作

##### **State root**

Rollup在主链上拥有一个(或者一系列相互关联的)合约，用来维护Rollup层中的状态记录，这个状态记录实际上是一棵默克尔树的根节点存储的哈希值，这个哈希值被称为state root。二叉树的叶子节点上记录着当前rollup层账户的状态信息。

对于每两个状态信息(例如State 1/State 2)，我们可以根据某种哈希公式计算出一个唯一的哈希值(eg: Hash(1,2) )来作为这两个叶子节点的父亲节点，依次一层一层往上类推，最终得到一个哈希值存储在根节点中：咱不需要知道怎样计算哈希值，咱们只需要记住几件事情。

1. 任何一个状态的变化都会导致Root hash发生变化；

2. 如果两棵树的根哈希值相同，那说明他们的叶子结点存储的信息完全一致（因此只需要对比两个根节点哈希值就可以确认底层状态信息的一致性；

3. 根据根节点的哈希值和下载相邻哈希值，我们可以确认某一个状态信息存在于这颗哈希树中。

Rollups 旨在通过压缩第 1 层区块链上的数据足迹来降低 gas 费用。汇总工作原理的基本思想是，它将大部分事务——计算（和状态存储）——从基础链推到第二层，同时将事务数据提交回底层的第 1 层链进行存储。

首先Rollup在主链上拥有一个(或者一系列相互关联的)合约，用来维护Rollup层中的状态记录，这个状态记录实际上是一棵默克尔树的根节点存储的哈希值，这个哈希值被称为state root。

![](D:\Learn\web3\note\深入学习\img\b21c8701a18b87d68b3e61f142b20d331e30fd22.webp)

##### Batch

当rollup上发生交易的时候，会产生新的state root。

但是如果每发生一笔交易就签名并在主链更新一次state root，产生的成本反而会比将这些交易在Layer1上执行还要高。

所以rollup中产生的交易就被按批次打包汇总，同时根据这批交易全部执行完成后的状态，会产生一个新的state root。无论是谁将交易打包提交给主链上的智能合约，他都需要计算这个新的state root，并将其和上一个state root以及交易数据一并提交。

这一部分的打包被称为一个”batch”，运营商将batch提交给Rollup 合约后，主链会去验证新的state root是否正确，如果通过验证，则将state root更新为最新提交的state root，并最终完成一次rollup内的状态转移确认。

所以，Rollup的实质是将一大笔实际产生的交易汇总成一笔主链上的交易，这些交易由Rollup链来执行和计算，但会将数据提交给主链。这样既利用了主链的共识和安全性，同时提升了实际上的交易效率，降低了交易成本。

##### 压缩

这两种技术方案能够做到扩容，核心都是交易数据的压缩和打包（前面提到了rollup的一大改良就是将交易数据上链 因此“压缩”是针对这部分）。这是因为以太坊的区块 gas limit 是有上限的, 压缩后的交易越小，一次能提交给主链的交易就越多，平摊的费用越低。

Nonce：此参数的目的是防止重放。如果一个账户的当前 nonce 是 5，那么来自该账户的下一笔交易处理后，账户中的 nonce 将增加到 6。nonce一般来说可以到几千几万，但它是通过rlp编码可以动态缩短字节，所以以太坊网上的nonce大约是在3字节左右

Gasprice：是以10的负18次方为单位的一个数，也是rl编码，大概是8字节

Gas：这边指的是你愿意付出的gas个数，一般都不多。一般以太坊一个block的gas上限是允许2千万个gas。一般一个转账交易gas差不多是2万，调个合约差不多是10万-20万，顶多几十万。所以这边平均差不多3个字节

To：以太坊上一个地址差不多是21个字节，而且以太坊地址范围很大

Value：指的是转账时的钱数，很多时候调合约value都是0，因为你不需要往合约里转账。但比如我转5eth给你，那value就有个值。单位也是10的负18次方，rlp编码，9个字节差不多

Signature：签名就比较固定 差不多68个字节

所以这样算下来，一个eth交易差不多112个。因为roll-up是往L2发，所以只要能表达出完整信息，L2方案是可以自定义格式的。但是这些信息他可以挑选，和压缩。比如：

Nonce：在 rollup 中可以完全省略 nonce。因为完全可以从 pre-state 中恢复 nonce。

GasPrice：可以在每批中设置一个固定的费用水平，或者甚至将 gas 支付完全移到汇总协议之外，并让交易者通过渠道向批次创建者支付费用。

Gas：可以在 batch 层面设置 gas 限制，选择一些特定的值，

To：可以通过默克尔树上的索引来替换 20 字节的地址（例如，如果地址是添加到树中的第 4527 个地址，我们只需使用索引 “4527” 来引用它。就可以限制到4个字节

Value：钱数把单位改一下，或者用其他技术法来存储。

Signature：使用 BLS 聚合签名，将多个签名整合为一个。然后可以一次性地针对整个消息批次“batch”验证签名。因为每个区块中可验证的聚合的签名数量上限是100，所以即使包含100笔签名的 大批次（batch）也能聚合成一笔签名。

最后省下来差不多12个字节。其实相当于限制了精度，但信息范围不变，依旧几乎表达了完整的信息。这就是roll up为什么能扩容的重点。但这扩容的原因主要是因为在主链上，calldate是有限制的，因为calldate它每个字节都会消耗主网上的一点gas，而主链上一个blcok的总gas数上有限制的。所以就限制了calldata能包括的字节的总数。

这些压缩技巧是 rollup 扩容的关键，如果我们不对交易数据进行压缩，rollup 或许只能在主链的基础上的有大约 10 倍的提升效率，但有了这些压缩技巧，才能做到100倍甚至更高的压缩效率。

`RollUp`方案优点：

**a**.高吞吐量，低交易成本

**b**.交易数据存储在第 1 层链上，提高了透明度、安全性、抗审查性和去中心化性.交易数据上主网保证了数据的可用性。

**d**.与 EVM 和 Solidity 的兼容性允许开发人员将以太坊原生智能合约移植到汇总或使用现有工具来创建新的 dapp。

1. **Optimistic RollUp**
   乐观地假设所有交易都是有效的，并在没有任何初始证明的情况下提交批次。任何人可以在挑战期内，检测并证明有数据是虚假的。如果批处理被证明是有欺诈性的，那么Optimistic rollps会执行欺诈证明，并使用以太坊主链上的可用数据运行正确的交易计算。batch所包含的信息包括了pre-state root，post state root，和交易信息。
   
   根据pre-state root这一部分能够构建完整的默克尔树。根据交易信息，我们可以模拟执行batch中提交的交易，从而得到了新的账户状态，得到新的默克尔树，得到新的state root。将上一步得到的state root和batch中的state root进行比对从而验证batch中的是否正确。
   
   加密经济学有效性博弈的“`欺诈证明`”，实际上是让参与各方互相监督，通过惩罚机制来提高作弊成本。Optimistic使用`欺诈证明`对交易进行有效性验证。
   
   `优点`：
   
   **a**.optimistic rollup的欺诈证明保证了去信任的最终性，状态的有效性，而且并允许诚实的少数人保护链（理论上哪怕只有一个诚实节点都可以保证整条链的安全性），
   
   `缺点`：
   
   **a**.提款慢，通常需要等7天，以允许提交质疑和欺诈证明
   
   **b**.安全模型依赖于至少一个诚实节点
   
   与`Plasma`的区别：
   
   **a**.兼容以太坊EVM
   
   **b**.压缩数据上传到主链保证数据可见性和安全性

2. **ZK Rollup**
   ZK Rollup 采用零知识证明来保证交易有效。它的安全性建立在密码学基础之上，智能合约仅在交易数据被证明为正确之后才会接受状态转换。每次状态转换都有一个零知识证明，这保证了链上总是对应着一个正确的二层状态。zk的挑战在于生成、以及验证一个zk证明本身需要非常非常大量且复杂的计算，会出现硬件方面的中心化风险。
   
   `优点`：
   
   **a**.由于省略了验证者的工作和挑战期这个概念，一旦在 L1 上验证了有效性证明，就会批准状态更新，从而提供更快的交易最终确定性。（无须再等7-14天）.op 的数据可用性来自于经济学。为了能够良好的运转，Op必须设计合理的激励机制驱使一批主链上的验证人随时监测提交者，并准备提交欺诈证明，而zk的数据可用性依赖于密码学和代码。
   **b**.更好的数据压缩有助于降低calldata在以太坊上发布的成本，并最大限度地减少用户的汇总费用。属于目前压缩能力最强，效率最高的方案。(为了支持“欺诈证明”，Optimistic Rollup的每笔交易数据需要包涵交易提交者的签名。每条签名的大小是 64 bytes，这大大增加了提交上链的交易数据的字节数，从而很快达到 gas 上限。)
   `缺点`：
   
   **a**.硬件方面的中心化风险。生成有效性证明需要专门的硬件，硬件垄断有可能会导致对链进行集中控制。
   与`ZK RoleUp`的区别：
   
   **a**.optimistic rollup的欺诈证明保证了去信任的最终性,ZK RoleUp使用0知识证明。
   
   **b**.ZK RoleUp能压缩得更小，既拥有更高的TPS

### 总结

通用性方面，Optimistic Rollup 明显好于ZK Rollup，当然它的设计目标就是支持任意智能合约。而 ZK Rollup 目前仅适用于支付之类的特定交易，对于通用智能合约，由于创建零知识证明的成本非常高，部署起来困难较大。为了提高效率， 开发者正在开发专门的零知识证明虚拟机，比如 ZEXE。它在一定程度上可以缩短创建证明的时间，但是缺点是合约开发者需要大量的专业知识。Matter Labs团队基于ZK Rollup开发的新一代区块链扩展方案 ZK Sync，设计开发了一款以委托的方式生成零知识证明的沙盒式虚拟机，开发者不需要深入了解零知识证明领域的技术细节就可以编写出高效且安全的智能合约。

| rollup            | 可扩展性   | 延迟    | 安全性 | 通用性 |
| ----------------- | ------ | ----- | --- | --- |
| optimistic rollup | 450TPS | 一周    | 差   | 好   |
| zk rollup         | 680TPS | 20min | 好   | 差   |

### 一些参考链接

- https://www.likecs.com/show-203343060.html
- https://blog.csdn.net/TurkeyCock/article/details/84565660
- https://www.chaineye.info/27/course_article_detail
- https://abmedia.io/chainnews-introducing-plasma-and-rollup
