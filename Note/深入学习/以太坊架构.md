# 以太坊架构初识

### 比特币系统架构

以太坊建立之初，也是大量参考了比特币的架构，我们从比特币的架构解读开始。

比特币系统分为6层，由下至上依次是存储层，数据层，网络层，共识层，PRC层，应用层。

![](img\907813-20211115163806206-1782052453.jpg)

1. 存储层：主要用于存储比特币系统运行中的日志数据及区块链元数据，存储技术主要使用文件系统和 LevelDB。数据层主要用于处理比特币交易中的各类数据，如将数据打包成区块，将区块维护成链式结构，区块中内容的加密与哈希计算，区块内容的数字签名及增加时间戳印记，将交易数据构建成 Merkle 树，并计算 Merkle 树根节点的哈希值等。

2. 数据层：处理比特币交易中的各类数据，如将数据打包成区块，将区块维护成链式结构，区块中内容的加密与哈希计算，区块内容的数字签名及增加时间戳印记，将交易数据构建成 Merkle 树，并计算 Merkle 树根节点的哈希值等。

3. 网络层：用于构建比特币底层的 P2P 网络，支持多节点动态加入和离开，对网络连接进行有效管理，为比特币数据传输和共识达成提供基础网络支持服务。

4. 共识层：主要采用了 PoW(Proof Of Work)共识算法。在比特币系统中，每个节点都不断地计算一个随机数(Nonce)，直到找到符合要求的随机数为止。在一定的时间段内，第一个找到符合条件的随机数将得到打包区块的权利，这构建了一个工作量证明机制。

5. RPC层：实现了 RPC 服务，并提供 JSON API 供客户端访问区块链底层服务

6. 应用层：主要承载各种比特币的应用，如比特币开源代码中提供了 bitcoin client。该层主要是作为 RPC 客户端，通过 JSON API 与 bitcoin 底层交互。除此之外，比特币钱包及衍生应用都架设在应用层上。

### 

### 以太坊架构

根据以太坊白皮书的描述，以太坊的结构如下图所示。以太坊的架构跟比特币的架构十分相似。

![](img\342ac65c10385343e43a06b98e16c27acb8088be.webp)

1. 存储层：存储层主要用于存储以太坊系统运行中的日志数据及区块链元数据，存储技术主要使用文件系统和 LevelDB。

2. 数据层：主要用于处理以太坊交易中的各类数据，如将数据打包成区块，将区块维护成链式结构，区块中内容的加密与哈希计算，区块内容的数字签名及增加时间戳印记，将交易数据构建成 Merkle 树，并计算 Merkle 树根节点的 hash 值等。以太坊相对于比特币添加了交易池的概念，指一个账户向另一个账户发送被签名的数据包的过程，而交易池则存放通过节点验证的交易，这些交易会在矿工挖出的新区块里。`Event`指的是和以太坊虚拟机提供的日志接口，当事件被调用时，对应的日志信息被保存在日志文件中。

3. 网络层：与比特币一样，以太坊的系统也是基于 P2P 网络的，在网络中每个节点既有客户端角色，又有服务端角色。

4. 协议层：协议层是以太坊提供的供系统各模块相互调用的协议支持，主要有 HTTP、RPC协议、LES、ETH 协议、Whipser 协议等。以太坊基于 HTTP Client 实现了对 HTTP 的支持，实现了 GET、POST 等 HTTP方法。外部程序通过 JSON RPC 调用以太坊的 API 时需通过 RPC (远程过程调用) 协议。
   
   Whisper 协议用于 DApp 间通信。
   
   LES 的全称是轻量级以太坊子协议(Light Ethereum Sub-protocol)，允许以太坊节点同步获取区块时仅下载区块的头部，在需要时再获取区块的其他部分。

5. 共识层：在以太坊系统中有 PoW(Proof of Work)和 PoS(Proof of Stake)两种共识算法。

6. 合约层：合约层分为两层，底层是 EVM(Ethereum Virtual Machine，即以太坊虚拟机)，上层的智能合约运行在 EVM 中。智能合约是运行在以太坊上的代码的统称，一个智能合约往往包含数据和代码两部分。智能合约系统将约定或合同代码化，由特定事件驱动触发执行。因此，在原理上适用于对安全性、信任性、长期性的约定或合同场景。在以太坊系统中，智能合约的默认编程语言是 Solidity，一般学过 JavaScript 语言的读者很容易上手 Solidity。

7. 应用层：DApp(Decentralized Application，分布式应用)、以太坊钱包等多种衍生应用，是目前开发者最活跃的一层。
